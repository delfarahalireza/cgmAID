# cgmAID

Automated insulin delivery and meal detection algorithms based on continuous glucose monitoring (CGM) time-series data and food intake.

## Overview
This repository provides:
- A comprehensive algorithm for detecting meal times and estimating calories from CGM data.
- A PID controller for automated insulin delivery with realistic constraints and safety features.

## Meal Detection Algorithm

The `meal_detection_algorithm.py` script implements a robust method to detect meal events and estimate their caloric content from CGM data. It includes:
- Glucose rate of change analysis
- Peak detection and classification
- Meal timing estimation
- Calorie estimation based on glucose response
- Meal type classification (breakfast, lunch, dinner, snack)

### Features
- Handles noisy and irregular CGM data
- Estimates meal times and types based on glucose dynamics
- Provides summary statistics and visualization for detected meals

### Usage
1. Prepare your CGM data as a CSV file with columns: `participant_id`, `timestamp`, `date`, `glucose_value`.
2. Run the script:
   ```bash
   python meal_detection_algorithm.py
   ```
3. The script will:
   - Preprocess the data
   - Detect meals for each participant
   - Save detected meals to `detected_meals.csv`
   - Print summary statistics
   - Plot an example of meal detection for a sample participant

## PID Controller

The `improved_pid_controller.py` script provides an enhanced PID controller for automated insulin delivery. It includes:
- Realistic target glucose and PID gains
- Basal and bolus insulin calculation
- Safety features (suspend on low glucose, rate limiting, IOB adjustment)
- Test cases for various glucose scenarios

### Features
- Adjustable parameters for target glucose, PID gains, basal rate, and safety limits
- Handles insulin on board (IOB) to prevent over-delivery
- Computes meal bolus based on carbohydrate intake and correction factor
- Rate limiting to avoid rapid changes in insulin delivery

### Usage
Run the script to see test outputs for different scenarios:
```bash
python improved_pid_controller.py
```

The script will print:
- Insulin rate responses to various glucose levels
- Effect of insulin on board (IOB)
- Meal bolus calculations for different meals
- Rate limiting demonstration
- Controller parameters summary

## Requirements
- Python 3.10.18
- numpy
- pandas
- scipy
- matplotlib

Install dependencies with:
```bash
pip install numpy pandas scipy matplotlib
```

## Figures

Below are example figures generated by the cgmAID project:

**Meal Detection Summary**

![Meal Detection Summary](figures/meal_detection_summary.png)

**Glucose Distribution Analysis**

![Glucose Distribution Analysis](figures/glucose_distribution_analysis.png)

**Controller Summary Statistics**

![Controller Summary Statistics](figures/controller_summary_statistics.png)

**Subject 1003 CGM, Meals and Automated Insulin Delivery Traces**

![Subject 1003 Traces](figures/subject_1003_comparison.png)

**Subject 1006 CGM, Meals and Automated Insulin Delivery Traces**

![Subject 1006 Traces](figures/subject_1006_comparison.png)

**Subject 1007 CGM, Meals and Automated Insulin Delivery Traces**

![Subject 1007 Traces](figures/subject_1007_comparison.png)

**Subject 1012 CGM, Meals and Automated Insulin Delivery Traces**

![Subject 1012 Traces](figures/subject_1012_comparison.png)

**Subject 1014 CGM, Meals and Automated Insulin Delivery Traces**

![Subject 1014 Traces](figures/subject_1014_comparison.png)

**Subject 1017 CGM, Meals and Automated Insulin Delivery Traces**

![Subject 1017 Traces](figures/subject_1017_comparison.png)

## License
See the [LICENSE](LICENSE) file for license information.
